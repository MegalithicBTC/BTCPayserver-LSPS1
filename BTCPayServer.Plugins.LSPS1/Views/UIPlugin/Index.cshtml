@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Plugins.LSPS1.Views
@using Microsoft.AspNetCore.Antiforgery
@inject IAntiforgery AntiXsrf
@model BTCPayServer.Plugins.LSPS1.Controllers.UIPluginController.PluginPageViewModel

@{
    ViewData.SetActivePage(PluginNavPages.Index, "Get Lightning Channel");
    // ✨ FIX: Context is already HttpContext
    var xsrf = AntiXsrf.GetAndStoreTokens(Context).RequestToken;
}

<h1>@ViewData["Title"]</h1>

<h2>Get A Lightning Channel</h2>

<div class="form-group mb-3">
    <button id="lsps-connect" class="btn btn-primary">Connect to Lightning Service Provider</button>
    <span id="status-message" class="ms-3"></span>
</div>

@section Scripts {
<script nonce="@Context.Items["CSPNonce"]">
    document.getElementById('lsps-connect').addEventListener('click', async () => {
        const statusEl = document.getElementById('status-message');
        statusEl.textContent = 'Connecting…';
        statusEl.className = 'ms-3 text-muted';

        try {
            const storeId = '@Model.StoreId';
            const res = await fetch(`/stores/${storeId}/plugins/lsps1/get-info-connect`, {
                method: 'POST',
                headers: { 'RequestVerificationToken': '@xsrf' }
            });

            const { ok, msg } = await res.json();
            statusEl.textContent = msg;
            statusEl.className   = ok ? 'ms-3 text-success' : 'ms-3 text-danger';
        } catch (err) {
            statusEl.textContent = 'Error: ' + err.message;
            statusEl.className   = 'ms-3 text-danger';
        }
    });
</script>
}